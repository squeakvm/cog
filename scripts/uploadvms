#!/bin/sh
IFS="	
"
REV="`svnversion | sed 's/^.*://'`"
case $REV in
*M)	echo -n "source tree is modified, are you sure you want to continue? "
	read a
	case $a in
	y|Y)	;;
	*)		exit 1
	esac
	REV="`svnversion | sed 's/^.*://' | sed 's/M//'`";;
esac
TAG=`date +%g.%U.`$REV
echo REV=$REV TAG=$TAG

CSARCS="Cog.app.tgz	coglinux.tgz	cogwin.zip"
CMARCS="cogmtlinux.tgz	CogMT.app.tgz	cogmtwin.zip"
NSARCS="Newspeak Virtual Machine-$TAG.dmg	nsvmlinux-$TAG.tgz	nsvm-$TAG.msi"
NMARCS="Newspeak Virtual MachineMT-$TAG.dmg	nsvmmtlinux-$TAG.tgz	nsvmmt-$TAG.msi"
if [ $# = 0 ]; then
	ARCHIVES="$CSARCS	$CMARCS		$NSARCS"
	CheckDMG=1
	CheckMSI=1
else
	ARCHIVES=
	CheckDMG=
	CheckMSI=
	while [ -n "$1" ]; do
		case $1 in
		-r)		REV=$1;;
		-c)		ARCHIVES="$ARCHIVES		$CSARCS		$CMARCS";;
		-cl)	ARCHIVES="$ARCHIVES	coglinux.tgz";;
		-cm)	ARCHIVES="$ARCHIVES	Cog.app.tgz";;
		-cw)	ARCHIVES="$ARCHIVES	cogwin.zip";;
		-ctl)	ARCHIVES="$ARCHIVES	cogmtlinux.tgz";;
		-ctm)	ARCHIVES="$ARCHIVES	CogMT.app.tgz";;
		-ctw)	ARCHIVES="$ARCHIVES	cogmtwin.zip";;
		-nl)	ARCHIVES="$ARCHIVES	nsvmlinux-$TAG.tgz";;
		-nm)	ARCHIVES="$ARCHIVES	Newspeak Virtual Machine-$TAG.dmg"
				CheckDMG=1;;
		-nw)	ARCHIVES="$ARCHIVES	nsvm-$TAG.msi"
				CheckMSI=1;;
		-n)		ARCHIVES="$ARCHIVES		$NSARCS";;
		-l)		ARCHIVES="$ARCHIVES	coglinux.tgz	cogmtlinux.tgz	nsvmlinux-$TAG.tgz";;
		-m)		ARCHIVES="$ARCHIVES	Cog.app.tgz	CogMT.app.tgz	Newspeak Virtual Machine-$TAG.dmg"
				CheckDMG=1;;
		-w)		ARCHIVES="$ARCHIVES	cogwin.tgz	cogmtwin.zip	nsvm-$TAG.msi"
				CheckMSI=1;;
		-?|-h)  echo usage: $0 [-r REV -l -m -w -c -n -cl -cm -cw -ctl -ctm -ctw -nl -nm -nw]; exit 0;;
		*)	break
		esac
		shift
	done
fi
if [ -n "$CheckDMG" -a ! -f "Newspeak Virtual Machine-$TAG.dmg" ]; then
	NMID=nscogbuild/macbuild/installer
	if [ -f "$NMID/Newspeak Virtual Machine-$TAG.dmg" ]; then
		ln "$NMID/Newspeak Virtual Machine-$TAG.dmg" .
	else
		echo Newspeak Virtual Machine-$TAG.dmg is missing 1>&2
		exit 1
	fi
fi
if [ -n "$CheckMSI" -a ! -f nsvm-$TAG.msi ]; then
	NWID=nscogbuild/cygwinbuild/installer
	if [ -f "$NWID/nsvm-$TAG.msi" ]; then
		ln "$NWID/nsvm-$TAG.msi" .
	else
		echo nsvm-$TAG.msi is missing 1>&2
		exit 1
	fi
fi
if [ ! -f README.$REV ]; then
	cat <<END >README.$REV
N.B. For Squeak/Pharo/Croquet please use the archives whose names begin with
     Cog or cog.  The archives whose names begin with nsvm or Newspeak are
     for Newspeak and are missing plugins required by Squeak/Pharo/Croquet.
     VMs with "mt" or "MT" in the name are multi-threaded VMs which support
     non-blocking FFI calls.

END
	svn log platforms/Cross/vm/sqSCCSVersion.h >>README.$REV
	vi README.$REV
fi
ssh -x eliotmiranda@bugsy.dreamhost.com mkdir mirandabanda.org/files/Cog/VM/VM.r$REV
echo scp README.$REV $ARCHIVES "$@" eliotmiranda@bugsy.dreamhost.com:mirandabanda.org/files/Cog/VM/VM.r$REV
scp README.$REV $ARCHIVES "$@" eliotmiranda@bugsy.dreamhost.com:mirandabanda.org/files/Cog/VM/VM.r$REV
